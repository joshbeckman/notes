{%- comment -%}
*
* This file contains the markup for the 'Same Source' posts you see at the end
* of all blogposts. It contains the markup to create a small of all the posts
* that are related by source (has the same tag with a source type prefix).
*
{%- endcomment -%}

{%- if page.content-type == "post" -%}
  {%- assign sameTagCount = 0 -%}
  {%- assign minCommonTags = 1 -%}
  {%- for post in site.posts -%}
    {%- for tag in post.tags -%}
      {%- if tag contains "articles-" or tag contains "books-" or tag contains "supplementals-" -%}
        {%- if post.url != page.url -%}
          {%- if page.tags contains tag -%}
            {%- unless post.content contains page.title -%}
              {%- assign sameTagCount = sameTagCount | plus: 1 -%}
            {%- endunless -%}
          {%- endif -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endfor -%}

  {%- if sameTagCount >= minCommonTags-%}
    {%- assign display_class = 'hide' -%}
      {%- if site.preferences.related.enabled -%}
        {%- assign display_class = 'show' -%}
      {%- endif -%}
    <section class="related {{display_class}}" id="jekyll-seamless-relatedposts">
      <h3 id="related" class="medium-small">
        Same Source
      </h3>
      <p class="">
      <ul class="arrows">
      {%- assign maxRelated = 7 -%}
      {%- assign minCommonTags =  1 -%}
      {%- assign maxRelatedCounter = 0 -%}
      {%- for post in site.posts -%}
          {%- assign sameTagCount = 0 -%}
          {%- for tag in post.tags -%}
            {%- if post.book == page.book -%}
              {%- if post.url != page.url -%}
                {%- if page.tags contains tag -%}
                  {%- unless post.content contains page.title -%}
                    {%- assign sameTagCount = sameTagCount | plus: 1 -%}
                  {%- endunless -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if sameTagCount >= minCommonTags -%}
            <li>
              <a href="{{post.url}}">
                {{ post.content | strip_html | strip | escape | truncate: 70}}
              </a>
            </li>
            {%- assign maxRelatedCounter = maxRelatedCounter | plus: 1 -%}
            {%- if maxRelatedCounter >= maxRelated -%}
              {%- break -%}
            {%- endif -%}
          {%- endif -%}
      {%- endfor -%}
        <li>
          <a href="/sources/#{{page.book}}">
            View all
          </a>
        </li>
      </ul>
      </p>
    </section>
  {%- endif -%}
{%- endif -%}
