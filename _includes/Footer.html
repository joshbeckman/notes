<dialog id="hotkeyDialog">
    <h2>Keyboard Shortcuts</h2>
    <table>
        <thead>
            <tr>
                <th>Key</th>
                <th>Action</th>
            </tr>
        </thead>
        <tr>
            <td><kbd>o</kbd></td>
            <td>Source</td>
        </tr>
        <tr>
            <td><kbd>e</kbd></td>
            <td>Edit</td>
        </tr>
        <tr>
            <td><kbd>i</kbd></td>
            <td>Insight</td>
        </tr>
        <tr>
            <td><kbd>r</kbd></td>
            <td><a href="/random">Random</a></td>
        </tr>
        <tr>
            <td><kbd>h</kbd></td>
            <td><a href="/">Home</a></td>
        </tr>
        <tr>
            <td><kbd>s</kbd> or <kbd>/</kbd></td>
            <td><a href="/search">Search</a></td>
        </tr>
    </table>
  <form method="dialog">
    <button>Close</button>
  </form>
</dialog>
<footer id="footer" class="footer print-hidden">
        <div class="titles">
          <a class="site-title" href="{{ site.url }}">{{site.title}}</a>
          <p class="site-subtitle">{{ site.description }}</p>
        </div>
        <nav class="menu">
<div class="menu-item menu-item-with-title">
    <span class="menu-item-title" data-label="where to find me">PRESENCE</span>        <a class="menu-item-link" href="/subscribe" data-label="RSS / Social / Newsletter">Subscribe</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/about" data-label="contact / accounts">About</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" id="status-fetch" href="#" data-label="????????">Status</a>    </div>
<div class="menu-item menu-item-with-title">
    <span class="menu-item-title" data-label="of this site">SECTIONS</span>        <a class="menu-item-link" href="/blog" data-label="my writing">Blog</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/notes" data-label="found writing">Notes</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/replies" data-label="to others">Replies</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/blog/photos" data-label="taken">Photos</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/exercise" data-label="log">Exercise</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/talks" data-label="I've given">Talks</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/podcasts" data-label="I've been on">Podcasts</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/proverbs" data-label="guidance">Proverbs</a>    </div>
<div class="menu-item menu-item-with-title">
    <span class="menu-item-title" data-label="on this site">TOOLS</span>        <a class="menu-item-link" href="/search" data-label="posts & pages">Search</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/latest" data-label="posts">Latest</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/on-this-day" data-label="in time">On This Day</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/random" data-label="discovery">Random</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/guestbook" data-label="to sign">Guestbook</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/sequences" data-label="research chains">Sequences</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/anchors" data-label="most linked">Anchors</a>    </div>
<div class="menu-item">
            <a class="menu-item-link" href="/network" data-label="graph">Network</a>    </div>
<div class="menu-item menu-item-with-title">
    <span class="menu-item-title" data-label="build">SITE</span>
  <a class="menu-item-link" href="/about-this-site" data-label="version">{{site.version}}</a>
</div>
<div class="menu-item">
    <span class="menu-item-link" data-label="updated"><time datetime="{{ site.build_time }}" class="time-relative">{{site.build_time}}</time></span>
</div>
</nav>
</footer>
<span class="print-only">{{site.title}}: https://{{site.url | domainify}}{{ page.url }}</span>
<div id="qrcode" class="print-only" style="width: 130px;height: 130px"></div>
<script async src="/assets/js/lazyload.min.js"></script>
<script async src="/assets/js/hotkeys.min.js"></script>
<script data-goatcounter="https://joshbeckman.goatcounter.com/count" async src="https://gc.zgo.at/count.js"></script>
<script>
(function figurePadding() {
        document.addEventListener('DOMContentLoaded', function() {
            const imgWrappers = document.querySelectorAll('.img-wrapper');
            imgWrappers.forEach(function(wrapper) {
                const img = wrapper.querySelector('img');
                if (img) {
                    function setPadding() {
                        if (img.naturalHeight && img.naturalWidth) {
                            const aspectRatio = (img.naturalHeight / img.naturalWidth) * 100;
                            wrapper.style.paddingBottom = aspectRatio + '%';
                        }
                    }
                    if (img.complete && img.naturalHeight) {
                        setPadding();
                    } else {
                        img.addEventListener('load', setPadding);
                        img.addEventListener('error', function() {
                            wrapper.style.paddingBottom = '56.25%'; // 16:9 fallback
                        });
                    }
                }
            });
            var figures = document.querySelectorAll('.with-caption');
            if (figures) { 
                figures.forEach(figure => { 
                    if (figure.nextElementSibling && figure.nextElementSibling.classList.contains('with-caption') || 
                        !figure.nextElementSibling && figure.previousElementSibling.classList.contains('with-caption')) {
                        figure.classList.add('special-caption');
                    }
                });
            }
        });
})();
if (document.getElementById("cusdis_thread")) {
  var script = document.createElement('script');
  script.src = 'https://cusdis.com/js/cusdis.es.js';
  script.async = true;
  document.body.appendChild(script);
}
(function searchInitListener() {
  let searchInput = document.getElementById("search-input");
  if (window.location.pathname == "/search/") {
    searchInput.focus();
  }
})();
function prepareImagesForLightbox() {
    if (window.innerWidth < 1500) {
        return;
    }
    let images = document.querySelectorAll('article section img, header img, .text img');
    for (let i = 0; i < images.length; i++) {
        if (images[i].classList.contains('no-lightbox')) {
            continue;
        }
        let img = images[i];
        let a = document.createElement('a');
        a.href = img.src;
        a.classList.add('ps');
        a.dataset.pswpWidth = img.naturalWidth;
        a.dataset.pswpHeight = img.naturalHeight;
        img.parentNode.insertBefore(a, img);
        a.appendChild(img);
    }
    if (document.querySelectorAll('a.ps').length == 0) {
        return;
    }
    var script = document.createElement('script');
    script.src = '/assets/js/photoswipe.umd.min.js';
    script.async = true;
    document.body.appendChild(script);
    var script2 = document.createElement('script');
    script2.src = '/assets/js/photoswipe-lightbox.umd.min.js';
    script2.async = true;
    var bothLoaded = 0;
    script.onload = script2.onload = function () {
      console.log('PhotoSwipe scripts loaded');
        bothLoaded++;
        if (bothLoaded < 2) {
            return;
        }
        var lightbox = new PhotoSwipeLightbox({
            gallery: 'article section, header, .text',
            children: 'a.ps',
            pswpModule: PhotoSwipe
        });
        lightbox.init();
      console.log('PhotoSwipe lightbox initialized');
    };
    document.body.appendChild(script2);
}
window.addEventListener('load', prepareImagesForLightbox);
window.addEventListener('load', function () {
    lazyload();
});

(function articleLinks() {
    var links = document.querySelectorAll('article .h-entry a');
    for (var i = 0; i < links.length; i++) {
        var link = links[i];
        var linkIsLocal = link.href.indexOf(window.location.host) > -1 || link.href[0] == '/';
        if (!linkIsLocal) {
            link.target = '_blank';
            link.rel = 'noopener';
        }
    }
})();

(function logoAnimator() {
  var paths = document.querySelectorAll('.name-svg path, .name-svg circle');
  var lastPathIndex = paths.length - 1;
  [].slice.call(paths).map(function(path) {
    path.setAttribute('stroke-dasharray', path.getTotalLength());
    path.setAttribute('stroke-dashoffset', path.getTotalLength());
  });
  if (paths.length > 0) {
    animateNamePath(paths[0], 0);
  }
  function animateNamePath(path, index) {
    function step() {
      var value = parseFloat(path.getAttribute('stroke-dashoffset'));
      if (value <= 1) {
        if (index < lastPathIndex) {
          animateNamePath(paths[index + 1], index + 1);
        }
        return;
      }
      var speed = value > 100 ? 12 : (value > 75 ? 10 : (value > 50 ? 8 : (value > 25 ? 6 : 1)));
      path.setAttribute('stroke-dashoffset', value - speed);
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }
})();
function timeAgo(date) {
    var now = new Date();
    var seconds = Math.floor((now - date) / 1000);
    var minutes = Math.floor(seconds / 60);
    var hours = Math.floor(minutes / 60);
    var days = Math.floor(hours / 24);
    var months = Math.floor(days / 30);
    var years = Math.floor(months / 12);

    if (minutes < 1) {
        return "just now";
    } else if (minutes < 2) {
        return "a minute ago";
    } else if (hours < 1) {
        return minutes + " minutes ago";
    } else if (hours < 2) {
        return "an hour ago";
    } else if (days < 1) {
        return hours + " hours ago";
    } else if (days < 2) {
        return "yesterday";
    } else if (days < 7) {
        return days + " days ago";
    } else if (days < 14) {
        return "last week";
    } else if (months < 1) {
        return days + " days ago";
    } else if (months < 2) {
        return "last month";
    } else if (years < 1) {
        return months + " months ago";
    } else if (years < 2) {
        return "last year";
    } else if (years < 10) {
        return years + " years ago";
    } else {
        return date.toLocaleDateString();
    }
}
(function setTimeAgo() {
  function timeAgoInterval() {
    var timeElements = document.querySelectorAll('time');
    var ago;
    for (var i = 0; i < timeElements.length; i++) {
      ago = timeAgo(new Date(timeElements[i].getAttribute('datetime')));
      timeElements[i].title = ago;
      if (timeElements[i].classList.contains('time-relative')) {
        timeElements[i].textContent = ago;
        timeElements[i].title = new Date(timeElements[i].getAttribute('datetime')).toLocaleString();
      }
    }
  }
  setInterval(timeAgoInterval, 60000);
  timeAgoInterval();
})();
(function appendToSession() {
// append to session storage the current url
  if (!window.sessionStorage) {
      return;
  }
  var currentUrl = window.location.href.split(window.location.host)[1];
  var sessionPath = window.sessionStorage.getItem('sessionPath');
  if (sessionPath) {
    var urls = sessionPath.split(',');
    if (urls.indexOf(currentUrl) == -1) {
      urls.push(currentUrl);
      window.sessionStorage.setItem('sessionPath', urls.join(','));
    }
  } else {
    window.sessionStorage.setItem('sessionPath', currentUrl);
  }
})();
window.addEventListener('load', function () {
    function search() {
      let searchInput = document.getElementById("search-input");
        if (searchInput) {
          searchInput.focus();
        } else {
            window.location.href = "/search";
        }
    }
    function edit() {
          var link = document.getElementById("edit-link");
          if (link) {
              link.click();
          } else {
            alert("No edit link found.");
          }
    }
    function random() {
        window.location.href = "/random";
    }
    function goHome() {
        window.location.href = "/";
    }
    function insight() {
        var details = document.querySelector('.post-insight details') || document.querySelector('.post-insight-agent details');
      if (details) {
        details.open = !details.open;
        details.scrollIntoView({behavior: "smooth"});
      } else {
        var path = window.location.pathname;
        window.location.href = "/insight?post=" + encodeURIComponent(path);
      }
    }
    function source() {
        var link = document.querySelector('a.quoteback-arrow') || document.querySelector('a.social-letterboxd') || document.querySelector('a.letterboxd-link') || document.querySelector('a.amazon-link') || document.querySelector('a.in_reply_to-source') || document.querySelector('a.source-url') || document.querySelector('a.canonical-url') || document.querySelector('a.asin-url');
        if (link) {
            link.click();
        } else {
          alert("No source link found.");
        }
    }
    function displayDialog() {
        var dialog = document.getElementById('hotkeyDialog');
        dialog.showModal();
    }
    hotkeys('o,e,i,r,h,s,/,shift+/,cmd+k', function (event, handler){
      switch (handler.key) {
        case 'o': source();
          break;
        case 'e': edit();
          break;
        case 'i': insight();
          break;
        case 'r': random();
          break;
        case 'h': goHome();
          break;
        case 's': search();
          break;
        case '/': search();
          break;
        case 'shift+/': displayDialog();
          break;
        case 'cmd+k': displayDialog();
          break;
        default: console.log(`No hotkey handler for ${handler.key}`);
      }
    });
});
(function addCopyButtons() {
    const divs = document.querySelectorAll('div.highlighter-rouge');
    divs.forEach(wrapper => {
        const pre = wrapper.querySelector('pre');
        wrapper.style.position = 'relative';
        const copyButton = document.createElement('button');
        copyButton.textContent = 'Copy';
        copyButton.className = 'copy-button';
        copyButton.addEventListener('click', function() {
            const text = pre.textContent || pre.innerText;
            navigator.clipboard.writeText(text).then(function() {
                copyButton.textContent = 'Copied!';
                if (window.goatcounter && window.goatcounter.count) {
                    window.goatcounter.count({ path: 'widget-copy-code', title: 'Copy code block', event: true });
                }
                setTimeout(function() {
                    copyButton.textContent = 'Copy';
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy text: ', err);
            });
        });
        wrapper.appendChild(copyButton);
    });
})();
(function statusFetcher() {
    const statusLink = document.getElementById('status-fetch');
    if (!statusLink) {
        return;
    }
  function listener(event) {
    event.preventDefault();
    fetchStatus();
  }
  statusLink.addEventListener('click', listener);
  function fetchStatus() {
    statusLink.dataset.label = 'Fetching...';
    var headers = new Headers();
    headers.append('Authorization', 'Bearer this-is-a-read-password');
  fetch('https://joshbeckman--5ffab9e262b911f09d000224a6c84d84.web.val.run/api', { mode: 'cors', headers: headers })
        .then(response => response.json())
        .then(data => {
          statusLink.textContent = data.status;
          statusLink.dataset.label = timeAgo(new Date(data.updated_at));
          statusLink.removeEventListener('click', listener);
          if (window.goatcounter && window.goatcounter.count) {
            window.goatcounter.count({ path: 'widget-status-fetch', title: 'Status widget', event: true });
          }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            statusLink.textContent = 'Status Unavailable';
        });
  }
})();
window.addEventListener('beforeprint', function() {
    var script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js';
    script.addEventListener('load', function() {
        var qrcode = new QRCode(document.getElementById('qrcode'), {
          text: document.location.href,
          width: 128,
          height: 128,
          colorDark: '#000',
          colorLight: '#fff',
          correctLevel: QRCode.CorrectLevel.H
        });
    });
    document.body.appendChild(script);
});
</script>
