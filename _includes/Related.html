{%- comment -%}
*
* This file contains the markup for the 'Related' posts that you see at the end
* of all blogposts. It contains the markup to create a small of all the posts
* that are related by tag.
*
{%- endcomment -%}

{%- if page.content-type == "post" -%}
  {%- assign sameTagCount = 0 -%}
  {%- assign minCommonTags =  1 -%}
  {%- for post in site.posts -%}
    {%- for tag in post.tags -%}
      {%- unless post.book == page.book -%}
        {%- if post.url != page.url -%}
          {%- if page.tags contains tag -%}
            {%- unless post.content contains page.title -%}
              {%- assign sameTagCount = sameTagCount | plus: 1 -%}
            {%- endunless -%}
          {%- endif -%}
        {%- endif -%}
      {%- endunless -%}
    {%- endfor -%}
  {%- endfor -%}

  {%- if sameTagCount >= minCommonTags-%}
    {%- assign display_class = 'hide' -%}
      {%- if site.preferences.related.enabled -%}
        {%- assign display_class = 'show' -%}
      {%- endif -%}
    <section class="related {{display_class}}" id="jekyll-seamless-relatedposts">
      <h3 id="related" class="medium-small">Related Notes</h3>
      <p class="">
      <ul class="similar">
      {%- assign maxRelated = 8 -%}
      {%- assign minCommonTags =  1 -%}
      {%- assign maxRelatedCounter = 0 -%}
      {%- for post in site.posts -%}
          {%- assign sameTagCount = 0 -%}
          {%- for tag in post.tags -%}
            {%- unless post.book == page.book -%}
              {%- if post.url != page.url -%}
                {%- if page.tags contains tag -%}
                  {%- unless post.content contains page.title -%}
                    {%- assign sameTagCount = sameTagCount | plus: 1 -%}
                  {%- endunless -%}
                {%- endif -%}
              {%- endif -%}
            {%- endunless -%}
          {%- endfor -%}
          {%- if sameTagCount >= minCommonTags -%}
            <li>
              <a href="{{post.url}}">
                {{ post.content | strip_html | strip | escape | truncate: 70}}
                {%- if post.book == page.book -%}
                  <em>from this source</em>
                {%- else -%}
                  <em>from {{ post.author }}</em>
                {%- endif -%}
              </a>
            </li>
            {%- assign maxRelatedCounter = maxRelatedCounter | plus: 1 -%}
            {%- if maxRelatedCounter >= maxRelated -%}
              {%- break -%}
            {%- endif -%}
          {%- endif -%}
      {%- endfor -%}
      </ul>
      </p>
    </section>
  {%- endif -%}
{%- endif -%}
