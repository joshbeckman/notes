<div class="post-social print-hidden">
  <div class="social-content">
    <h3>Comments &amp; Replies</h3>
    <div class="social-row">
      <ul class="social-links">
      {%- if page.letterboxd_review_url -%}
      <li><a class="social-letterboxd" href="{{page.letterboxd_review_url}}" target="_blank">on Letterboxd</a></li>
      {%- endif -%}
      {%- if page.youtube_video_url -%}
      <li><a class="social-youtube" href="{{page.youtube_video_url}}" target="_blank">on YouTube</a></li>
      {%- endif -%}
      {%- if page.mastodon_social_status_url -%}
      <li><a class="social-mastodon" href="{{page.mastodon_social_status_url}}" target="_blank">on Mastodon</a></li>
      {%- endif -%}
      {%- if page.bluesky_status_url -%}
      <li><a class="social-bluesky" href="{{page.bluesky_status_url}}" target="_blank">on Bluesky</a></li>
      {%- endif -%}
      {%- if page.hacker_news_url -%}
      <li><a class="social-hn" href="{{page.hacker_news_url}}" target="_blank">on HackerNews</a></li>
      {%- endif -%}
      {%- if page.strava_activity_url -%}
      <li><a class="social-strava" href="{{page.strava_activity_url}}" target="_blank">on Strava</a></li>
      {%- endif -%}
      <li><a class="social-webmentions" href="https://webmention.io/api/mentions.html?token=4N8Bpl6KX64j8VB4k5A3ww&target=https://www.joshbeckman.org{{ page.url }}" target="_blank"><span data-webmention-count data-url="https://www.joshbeckman.org{{ page.url }}">webmentions</span></a></li>
      <li><a class="social-email" href="/about#active-accounts">Reply via email</a></li>
      </ul>
      <form class="iine-like-button" action="https://vhiweeypifbwacashxjz.supabase.co/rest/v1/rpc/increment_hits?apikey=sb_publishable_EoB7MFJhCmb6PiAk-GPJ4w_PGhQ44Ru" method="post">
        <input type="hidden" name="page_slug" value="{{ page.url }}">
        <button type="submit" class="iine-button" data-icon="heart" aria-hidden="true">
          <noscript>â™¥</noscript>
        </button>
      </form>
    </div>
    <p>Did you like this post, repost it, or respond to it? Let me know by sending a <a href="https://indieweb.org/Webmention" target="_blank">webmention</a>:
    <br/>
    <form
      id="webmention-form"
      action="https://webmention.io/www.joshbeckman.org/webmention"
      method="POST"
    >
      <input
        id="webmention-source"
        type="url"
        autocomplete="url"
        required
        pattern="^https?:\/\/(.*)"
        name="source"
        placeholder="https://example.com/your-post"
      />
      <input id="webmention-submit" type="submit" name="submit" value="@ me" />
      <input id="webmention-format" type="hidden" name="format" value="html" />
      <input id="webmention-target" type="hidden" name="target" value="{{ site.url }}{{ page.url }}" />
    </form>
    </p>
    <p>or you can <a href="#cusdis" id="cusdis-link">leave a simple comment here</a>.</p>
    <div id="async_cusdis_thread"
      data-theme="auto"
      data-host="https://cusdis.com"
      data-app-id="0bbb76b5-e971-4d9c-8fa7-a4c9e1ff0984"
      data-page-id="{{ page.url }}"
      data-page-url="{{ site.url }}{{ page.url }}"
      data-page-title="{{ page.title }}"
    ></div>
  </div>
</div>
<script>
(function() {
    var postSocial = document.querySelector('.post-social');
    if (!postSocial) {
        return;
    }
    var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                loadBluesky();
                loadMastodon();
                loadHackerNews();
                loadWebmentions();
                observer.disconnect();
            }
        });
    }, {
        rootMargin: '50px'
    });
    observer.observe(postSocial);

    var cusdisLink = document.getElementById('cusdis-link');
    cusdisLink.addEventListener('click', function(event) {
        event.preventDefault();
        loadCusdis();
        cusdisLink.innerText = 'comment here';
    });

    function pluralize(count, singular, plural) {
        return count === 1 ? singular : (plural || singular + 's');
    }

    function loadWebmentions() {
        var webmentionLink = document.querySelector('.social-webmentions span[data-webmention-count]');
        if (!webmentionLink) {
            return;
        }
        var url = webmentionLink.getAttribute('data-url');
        fetch(`https://webmention.io/api/count?target=${url}`)
            .then(response => response.json())
            .then(data => {
                var count = data.count || 0;
                if (count === 0) {
                    webmentionLink.textContent = 'No webmentions yet';
                    return;
                }
                webmentionLink.textContent = `${count} ${pluralize(count, 'webmention')}`;
            })
            .catch(error => console.error('Error fetching webmentions:', error));
    }

    function loadMastodon() {
        var mastodon = document.querySelector('.social-mastodon');
        if (!mastodon) {
            return;
        }
        var mastodonStatusID = mastodon.getAttribute('href').match(/\/@[^/]+\/(\d+)/);
        fetch(`https://mastodon.social/api/v1/statuses/${mastodonStatusID[1]}`)
            .then(response => response.json())
            .then(data => {
                var reblogs = data.reblogs_count || 0;
                var favourites = data.favourites_count || 0;
                var replies = data.replies_count || 0;
                var quotes = data.quotes_count || 0;
                var parts = [];

                if (reblogs > 0) parts.push(`${reblogs} ${pluralize(reblogs, 'boost')}`);
                if (favourites > 0) parts.push(`${favourites} ${pluralize(favourites, 'favorite')}`);
                if (quotes > 0) parts.push(`${quotes} ${pluralize(quotes, 'quote')}`);
                if (replies > 0) parts.push(`${replies} ${pluralize(replies, 'reply', 'replies')}`);

                if (parts.length > 0) {
                    var text = parts.join(', ').replace(/, ([^,]*)$/, ', and $1');
                    mastodon.textContent = `${text} on Mastodon`;
                }
            })
            .catch(error => console.error('Error fetching Mastodon status:', error));
    }
    function loadCusdis() {
        var cusdis = document.getElementById('async_cusdis_thread');
        if (!cusdis) {
            return;
        }
        if (window.goatcounter && window.goatcounter.count) {
            window.goatcounter.count({ path: 'widget-cusdis-load', title: 'Cusdis comments widget', event: true });
        }
        cusdis.id = 'cusdis_thread';
        var script = document.createElement('script');
        script.src = 'https://cusdis.com/js/cusdis.es.js';
        document.body.appendChild(script);

        function adjustIframeHeight(iframe) {
            var heights = [];
            function load() {
                if (!iframe.contentWindow.document.body) {
                    return setTimeout(load, 500);
                }
                var height = iframe.contentWindow.document.body.scrollHeight;
                // Set the iframe height
                iframe.style.height = height + 'px';
                heights.push(height);
                // if the height has been the same for 1.5 seconds, stop polling
                if (heights.length > 3 && heights[heights.length - 1] === heights[heights.length - 2] && heights[heights.length - 2] === heights[heights.length - 3]) {
                    return;
                }
                setTimeout(load, 500);
            };
            load();
        }
        // poll to get the iframe
        (function waitForIframe() {
            var myIframe = document.querySelector('#cusdis_thread iframe');
            if (myIframe) {
                adjustIframeHeight(myIframe);
            } else {
                setTimeout(waitForIframe, 100);
            }
        })();
    }
    function loadBluesky() {
        var bluesky = document.querySelector('.social-bluesky');
        if (!bluesky) {
            return;
        }
        var blueskyPostID = bluesky.getAttribute('href').match(/\/post\/([^/]+)/);
        fetch(`https://public.api.bsky.app/xrpc/app.bsky.feed.getPosts?uris=at://did:plc:oclgvsz6g6bsosawrkchxyyq/app.bsky.feed.post/${blueskyPostID[1]}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.posts && data.posts.length > 0) {
                    var likes = data.posts[0].likeCount || 0;
                    var replies = data.posts[0].replyCount || 0;
                    var reposts = data.posts[0].repostCount || 0;
                    var quotes = data.posts[0].quoteCount || 0;
                    var parts = [];

                    if (likes > 0) parts.push(`${likes} ${pluralize(likes, 'like')}`);
                    if (replies > 0) parts.push(`${replies} ${pluralize(replies, 'reply', 'replies')}`);
                    if (reposts > 0) parts.push(`${reposts} ${pluralize(reposts, 'repost')}`);
                    if (quotes > 0) parts.push(`${quotes} ${pluralize(quotes, 'quote')}`);

                    if (parts.length > 0) {
                        var text = parts.join(', ').replace(/, ([^,]*)$/, ' and $1');
                        bluesky.textContent = `${text} on Bluesky`;
                    }
                }
            })
            .catch(error => console.error('Error fetching Bluesky post:', error));
    }
    function loadHackerNews() {
        var hn = document.querySelector('.social-hn');
        if (!hn) {
            return;
        }
        var hnItemID = hn.getAttribute('href').match(/id=(\d+)/);
        if (!hnItemID) {
            return;
        }
        fetch(`https://hacker-news.firebaseio.com/v0/item/${hnItemID[1]}.json`)
            .then(response => response.json())
            .then(data => {
                var score = data.score || 0;
                var comments = data.descendants || 0;
                var parts = [];

                if (score > 0) parts.push(`${score} ${pluralize(score, 'vote')}`);
                if (comments > 0) parts.push(`${comments} ${pluralize(comments, 'comment')}`);

                if (parts.length > 0) {
                    var text = parts.join(', ').replace(/, ([^,]*)$/, ' and $1');
                    hn.textContent = `${text} on HackerNews`;
                }
            })
            .catch(error => console.error('Error fetching HackerNews item:', error));
    }
})();
</script>
