#!/usr/bin/env ruby

require 'net/http'
require 'json'
require 'uri'

class Poster
  def run
    rating = nil
    cover_image_url = nil
    body = nil

    puts "Title:"
    title = gets.chomp
    slug = title.gsub(/[^a-zA-Z0-9\s]/, '').gsub(/\s+/, '-')

    puts "Date:"
    date = gets.chomp

    puts "Category:"
    category = gets.chomp

    case category
    when "movies", "books"
      puts "Rating:"
      rating = gets.chomp.to_i
      puts "IMDB ID:"
      imdb_id = gets.chomp
      cover_image_url = movie_cover_image(imdb_id)
    end

    filename = "#{category}/_posts/#{date}-#{slug}.md"

    File.open(filename, 'w') do |file|
      file.puts "---"
      file.puts "layout: Post"
      file.puts "title: #{title}"
      file.puts "toc: true"
      file.puts "cover_image_url: #{cover_image_url}"
      file.puts "custom_excerpt: "
      if rating
        file.puts "rating: #{rating}"
      end
      if imdb_id
        file.puts "imdb_id: #{imdb_id}"
      end
      file.puts "tags: "
      file.puts "---"
      file.puts ""
    end
    exec('e ' + filename)
  end

  def movie_cover_image(imdb_id)
    key = File.read(File.expand_path(".omdb_token")).strip
    url = "https://www.omdbapi.com/?i=#{imdb_id}&apikey=#{key}"
    uri = URI(url)
    response = Net::HTTP.get(uri)
    json = JSON.parse(response)
    json["Poster"]
  end
end

Poster.new.run
